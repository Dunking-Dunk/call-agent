generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Session as the primary entity for all call interactions
model Session {
  id        String        @id @default(uuid())
  // Call information
  startTime DateTime      @default(now())
  endTime   DateTime?
  status    SessionStatus @default(ACTIVE)

  // Caller information
  phoneNumber String?
  callerId    String?
  caller      Caller? @relation(fields: [callerId], references: [id])

  // Emergency details
  emergencyType EmergencyType?
  locationId    String?
  location      Location?      @relation(fields: [locationId], references: [id])
  description   String?
  priorityLevel Int?           @default(3) // 1-5, where 1 is highest priority

  // Transcript and related info
  transcriptEntries SessionTranscript[]
  dispatches        Dispatch[]

  // Additional fields
  responseNotes String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Session transcript entries
model SessionTranscript {
  id          String      @id @default(uuid())
  sessionId   String
  session     Session     @relation(fields: [sessionId], references: [id])
  timestamp   DateTime    @default(now())
  speakerType SpeakerType // Identifies whether agent or caller is speaking
  content     String      @db.Text
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Caller {
  id          String    @id @default(uuid())
  phoneNumber String?   @unique
  name        String?
  language    String?   @default("Tamil") // Tamil, English, Hindi
  sessions    Session[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Location {
  id             String      @id @default(uuid())
  address        String?
  landmark       String?
  gpsCoordinates String?
  city           String?
  district       String?
  sessions       Session[]
  responders     Responder[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
}

model Responder {
  id            String          @id @default(uuid())
  responderType ResponderType
  identifier    String // Vehicle number or badge ID
  status        ResponderStatus @default(AVAILABLE)
  locationId    String?
  location      Location?       @relation(fields: [locationId], references: [id])
  dispatches    Dispatch[]
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
}

model Dispatch {
  id           String         @id @default(uuid())
  sessionId    String
  session      Session        @relation(fields: [sessionId], references: [id])
  responderId  String
  responder    Responder      @relation(fields: [responderId], references: [id])
  dispatchTime DateTime       @default(now())
  arrivalTime  DateTime?
  status       DispatchStatus @default(DISPATCHED)
  notes        String?        @db.Text
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([sessionId, responderId])
}

// Enums
enum SessionStatus {
  ACTIVE // Call is in progress
  EMERGENCY_VERIFIED // Call confirmed as emergency
  DISPATCHED // Resources have been dispatched
  COMPLETED // Call and response completed
  DROPPED // Call disconnected
  TRANSFERRED // Call transferred elsewhere
  NON_EMERGENCY // Determined not to be an emergency
}

enum EmergencyType {
  MEDICAL
  POLICE
  FIRE
  OTHER
}

enum ResponderType {
  AMBULANCE
  POLICE
  FIRE
  OTHER
}

enum ResponderStatus {
  AVAILABLE
  DISPATCHED
  ON_ROUTE
  ON_SCENE
  RETURNING
  OUT_OF_SERVICE
}

enum DispatchStatus {
  DISPATCHED
  EN_ROUTE
  ARRIVED
  COMPLETED
  CANCELLED
}

// Speaker types for transcript entries
enum SpeakerType {
  AGENT
  CALLER
  SYSTEM
}
